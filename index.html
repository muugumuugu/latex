<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Advanced LaTeX Spreadsheet</title>
<script src="texme.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS_HTML"></script>
<style>
  body { font-family: sans-serif; padding: 20px; }
  .container { position: relative; overflow: auto; max-height: 600px; border: 1px solid #ccc; }
  .grid { display: grid; gap: 2px; }
  .cell { border: 1px solid #ccc; padding: 5px; min-height: 50px; overflow-wrap: break-word; box-sizing: border-box; }
  .input-cell { background: #f0f8ff; resize: none; width: 100%; }
  .render-cell { background: #fff; }
  .header { background: #ddd; font-weight: bold; text-align: center; position: sticky; z-index: 2; }
  .header.col { top: 0; }
  .header.row { left: 0; }
  .selected { outline: 2px solid #007bff; }
  button { padding: 6px 10px; margin-right: 5px; cursor: pointer; }
</style>
</head>
<body>

<h2>Advanced LaTeX Spreadsheet</h2>
<div>
  <button id="addRow">Add Row</button>
  <button id="addCol">Add Column</button>
  <button id="copySelection">Copy Selected</button>
  <button id="exportCSV">Export CSV</button>
</div>
<div class="container">
  <div class="grid" id="grid"></div>
</div>

<script>
window.onload = function () {
  const grid = document.getElementById('grid');
  const texmeLine = '<!DOCTYPE html><script src="texme.js"></script><textarea>';
  let numRows = 0, numCols = 0;
  const columnTypes = []; // 'latex', 'text', 'formula'
  const cellMap = {}; // cellId -> {type, value, formula?, element, renderElement?}
  const columnRules = {}; // colIndex -> [{condition, style}]

  // ----- Utilities -----
  function colName(n) {
    let name = '';
    while (n >= 0) { name = String.fromCharCode(65 + (n % 26)) + name; n = Math.floor(n/26)-1; }
    return name;
  }
  function rowName(n){ return n+1; }

  function cellId(col,row){ return colName(col)+rowName(row); }

  function normalizeInput(input){
    let code = input.value.replace(/^\s+/, '');
    if(!code.startsWith(texmeLine) && code.length>0) code=texmeLine+'\n\n'+code;
    input.value=code;
  }

  function renderPreview(input, preview){
    let code=input.value.replace(texmeLine,'').trim();
    preview.innerHTML = texme.render(code);
    window.MathJax.Hub.Queue(['resetEquationNumbers', MathJax.InputJax.TeX],
                             ['Typeset', window.MathJax.Hub, preview]);
    input.style.height='auto';
    input.style.height=input.scrollHeight+'px';
  }

  function evaluateFormula(formula, currentId){
    // formula like =SUM(A1:A3)+B2
    if(!formula.startsWith('=')) return formula;
    let expr = formula.slice(1);
    expr = expr.replace(/([A-Z]+[0-9]+)/g,(match)=>{
      const val = cellMap[match]?.value||0;
      return isNaN(val)?0:val;
    });
    try{ return eval(expr); } catch(e){ return '#ERR'; }
  }

  function applyConditionalFormatting(){
    for(let col in columnRules){
      columnRules[col].forEach(rule=>{
        for(let r=0;r<numRows;r++){
          const id=cellId(col,r);
          const cell=cellMap[id];
          if(!cell) return;
          let cond=rule.condition.replace(/([A-Z]+[0-9]+)/g,(m)=>cellMap[m]?.value||0);
          try{ if(eval(cond)) Object.assign(cell.element.style,rule.style); else Object.assign(cell.element.style,rule.defaultStyle||{});}catch(e){}
        }
      });
    }
  }

  function updateCell(cell){
    if(cell.type==='formula'){
      cell.value=evaluateFormula(cell.formula, cell.id);
      cell.element.value=cell.formula;
    } else if(cell.type==='latex'){
      cell.value=cell.element.value.replace(texmeLine,'').trim();
      renderPreview(cell.element, cell.renderElement);
    } else {
      cell.value=cell.element.value;
    }
  }

  function recalcAll(){
    for(let key in cellMap){ updateCell(cellMap[key]); }
    applyConditionalFormatting();
  }

  // ----- Cell creation -----
  function createCell(type, col, row){
    const id=cellId(col,row);
    if(type==='latex'){
      const input=document.createElement('textarea');
      input.className='cell input-cell'; input.placeholder='LaTeX';
      const render=document.createElement('div'); render.className='cell render-cell';
      input.addEventListener('input',()=>{updateCell(cellMap[id]); recalcAll();});
      grid.appendChild(input); grid.appendChild(render);
      cellMap[id]={type:'latex',element:input,renderElement:render,value:''};
    } else {
      const input=document.createElement('textarea'); input.className='cell input-cell';
      input.addEventListener('input',()=>{updateCell(cellMap[id]); recalcAll();});
      grid.appendChild(input);
      cellMap[id]={type,element:input,value:type==='formula'? '' : input.value,formula:type==='formula'?'' :undefined};
    }
  }

  function addColumn(){
    const type = prompt("Column type? latex/text/formula","latex");
    if(!['latex','text','formula'].includes(type)) return;
    const col=numCols;
    columnTypes.push(type);
    // Add header
    const header=document.createElement('div'); header.className='cell header col'; header.textContent=colName(col);
    grid.appendChild(header);
    for(let r=0;r<numRows;r++){ createCell(type,col,r); }
    numCols++;
    grid.style.gridTemplateColumns=`repeat(${numCols*2},1fr)`;
  }

  function addRow(){
    const row=numRows;
    // Row header
    const header=document.createElement('div'); header.className='cell header row'; header.textContent=rowName(row);
    grid.appendChild(header);
    for(let c=0;c<numCols;c++){ createCell(columnTypes[c],c,row); }
    numRows++;
  }

  // ----- Drag selection -----
  let isDragging=false;
  function startSelection(e){ isDragging=true; e.target.classList.add('selected'); e.preventDefault();}
  function duringSelection(e){ if(isDragging) e.target.classList.add('selected');}
  function endSelection(){ isDragging=false; }
  document.addEventListener('mouseup', endSelection);

  // ----- Copy selection -----
  function copySelection(){
    const selected=Array.from(grid.querySelectorAll('.selected'));
    if(!selected.length) return;
    const text=selected.map(c=>c.tagName==='TEXTAREA'?c.value:c.textContent).join('\t');
    const temp=document.createElement('textarea'); document.body.appendChild(temp);
    temp.value=text; temp.select(); document.execCommand('copy'); document.body.removeChild(temp);
    alert('Copied '+selected.length+' cells!');
  }

  // ----- Export CSV -----
  function exportCSV(){
    let csv='';
    for(let r=0;r<numRows;r++){
      let row=[];
      for(let c=0;c<numCols;c++){
        const id=cellId(c,r);
        const cell=cellMap[id];
        row.push('"'+(cell.value||'')+'"');
      }
      csv+=row.join(',')+'\n';
    }
    const blob=new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const link=document.createElement('a'); link.href=URL.createObjectURL(blob); link.download='spreadsheet.csv'; link.click();
  }

  // ----- Buttons -----
  document.getElementById('addRow').onclick=addRow;
  document.getElementById('addCol').onclick=addColumn;
  document.getElementById('copySelection').onclick=copySelection;
  document.getElementById('exportCSV').onclick=exportCSV;

  // Initialize
  addColumn(); addColumn(); addRow();
}
</script>

</body>
</html>
